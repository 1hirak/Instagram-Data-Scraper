$=jQuery;var $document=$(document),is_online=window.navigator.onLine,htaccess=$.trim($("#htaccess").val()),$btnExportExcel=$("#btnExport"),$loadingContainer=$(".progress-bar"),totalRequestUrl=0,currentMasterIndex=1,currentMasterProgress=0,logInfo=!0,isFilter=!1,is_chart_created=(htaccess=$.trim($("#is_htaccess_enable").val()),!1),navBarForm=$(".form-inline"),booClose=$(".close"),keyContainer=["#digitaslbi"],currentIndex=0,chkOpt=$("input[name='info-toggle']:checked").val(),Config={action:"account",infoFullMin:chkOpt,urlRequest:"includes/AjaxServices.php",userAgentStatus:is_online,btnSearch:"#btnSearch",txtSearch:"#txtSearch",queryFormTemplate:"#query-form-template",accountThumbPopup:"#account-thumbs",searchFormContainer:"#search-form-section",searchFormChartContainer:"#search-form-chart-section",lblCountSearchAccounts:"#CountSearchAccounts .badge.badge-pill",lblCountSearchHashtags:"#CountSearchHashtags .badge.badge-pill",lblSumOfTotalLikes:"#SumOfTotalLikes .badge.badge-pill",lblSumOfTotalComments:"#SumOfTotalComments .badge.badge-pill",lblSumOfTotalShare:"#SumOfTotalShare .badge.badge-pill",lblSumOfTotalPosts:"#SumOfTotalPosts .badge.badge-pill",chartTemplate:"#chart-template",offlineMsg:"Please enable Internet Connection. You are off-line",queryAccounts:1,queryHashtags:1,queryLikes:1,queryComments:1,queryKeywords:1,queryPosts:1,getItem:function(t){return this[t].toString()?(_l("Item found: "+t),this[t].toString()):(_l("Item not found: "+t),!1)},setItem:function(t,e){this[t]&&(_l("Item found and set value: "+t+" : "+e),this[t]=e)}},_l=function(t){!0===logInfo&&console.log(t)};function hasProp(t,e){return Object.prototype.hasOwnProperty.call(t,e)}$(document).ajaxError(function(t,e,n,o){errStr="",errStr+='<div class="alert alert-danger alert-dismissable">',errStr+='  <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>',errStr+="  <strong>Error in Request: </strong> "+o,errStr+="</div>",$(".error-handling .container-fluid").html(errStr).parent().removeClass("hide")});var stateProgress=function(){_l("currentMasterIndex: "+currentMasterIndex),_l("currentMasterProgress: "+currentMasterProgress)};function fnExcelReport(t){var e=document.getElementById(t),n="<table border='2px'>";for(j=0;j<1;j++)n+="<tr bgcolor='#87AFC6'>"+e.rows[j].innerHTML+"</tr>";for(j=1;j<e.rows.length;j++)n+="<tr>"+e.rows[j].innerHTML+"</tr>";return n=(n=(n=(n+="</table>").replace(/<A[^>]*>|<\/A>/g,"")).replace(/<img[^>]*>/gi,"")).replace(/<input[^>]*>|<\/input>/gi,""),"data:application/vnd.ms-excel, "+encodeURIComponent(n)}var Instagram=function(){this.stateError=!1,this.txtProgressState=0,this.info=[],this.urlInstagram="https://www.instagram.com",this.urlInstagramNext=null,this.InstaJSON=null,this.currentIndex=0,this.currentIndexPost=0,this.isSearchingForNext=!1,this.errorContainer=$(".user-error"),this.infoContainer=$(".user-info"),this.tableWrapper=$("#search-account-table"),this.tableContentWrapper=$("#search-account-table.table-striped tbody"),this.txtIndicator=$(".txt-progress"),this.sendRequestUrl=Config.getItem("urlRequest"),this.infoFullMin=Config.getItem("infoFullMin")};Instagram.prototype.setAccount=function(){this.info=[],this.info.Biography=this.InstaJSON.graphql.user.biography,this.info.UserName=this.InstaJSON.graphql.user.username,this.info.FullName=this.InstaJSON.graphql.user.full_name,this.info.user_id=this.InstaJSON.graphql.user.id,this.info.Posts=this.InstaJSON.graphql.user.edge_owner_to_timeline_media.count,this.info.Followers=this.InstaJSON.graphql.user.edge_followed_by.count,this.info.Following=this.InstaJSON.graphql.user.edge_follow.count,this.info.AccountHref=this.urlInstagram+"/"+this.InstaJSON.graphql.user.username,this.info.Thumbs=[]},Instagram.prototype.setMedia=function(){_l("Set Media Calling....");var n=this,t=Math.ceil(this.info.Posts/12);this.eventHandler("Likes & Comments: "+this.currentIndexPost+"/"+t+", "+this.info.FullName),this.txtProgressState=Math.ceil(100*this.currentIndexPost)/t,_l("New JSON Data .... "),_l(this.InstaJSON);var e=[],o=[],a=[],s=[],i=0,r=0,l=0;hasProp(this.InstaJSON,"graphql")&&(hasProp(this.InstaJSON.graphql,"user")&&(e=this.InstaJSON.graphql.user.edge_owner_to_timeline_media.edges,$.each(e,function(t,e){n.info.Thumbs.push({"thumb-src":e.node.thumbnail_resources[0].src,comments:e.node.edge_media_to_comment.count,likes:e.node.edge_media_preview_like.count}),o.push(e.node.edge_media_preview_like.count),a.push(e.node.edge_media_to_comment.count),s.push(e.node.video_view_count?e.node.video_view_count:0)}),$.each(o,function(){i+=parseInt(this)||0}),$.each(a,function(){r+=parseInt(this)||0}),$.each(s,function(){l+=parseInt(this)||0})),_l("Is Next Calling Value: "+this.isSearchingForNext),0==this.isSearchingForNext?(this.info.TotalLikes=i,this.info.TotalComments=r,this.info.TotalViews=l):(this.info.TotalLikes=parseInt(this.info.TotalLikes)+i,this.info.TotalComments=parseInt(this.info.TotalComments)+r,this.info.TotalViews=parseInt(this.info.TotalViews)+l),_l("Check Has Next from JSON: "+this.InstaJSON.graphql.user.edge_owner_to_timeline_media.page_info.has_next_page),1==this.InstaJSON.graphql.user.edge_owner_to_timeline_media.page_info.has_next_page?(this.urlInstagramNext=this.InstaJSON.graphql.user.edge_owner_to_timeline_media.page_info.end_cursor,this.currentIndexPost+=1,this.isSearchingForNext=!0):(this.currentIndexPost=1,this.isSearchingForNext=!1),void 0===this.info.TotalLikes&&(this.info.TotalLikes=0),void 0===this.info.TotalComments&&(this.info.TotalComments=0),void 0===this.info.TotalViews&&(this.info.TotalViews=0))},Instagram.prototype.buildViews=function(){var t="";t+='<tr class="info-row">',t+='<td><input class="tbl-chk" type="checkbox"></td>',t+='<td><a target="_blank" href="'+this.info.AccountHref+'">'+this.info.UserName+"</a></td>",t+="<td>"+this.info.Biography+"</td>",t+="<td>"+this.info.Followers+"</td>",t+="<td>"+this.info.Following+"</td>",t+="<td>"+this.info.Posts+"</td>",t+='<td><a href="#" data-toggle="modal" data-target="#thumb-'+this.info.UserName+'">'+this.info.TotalLikes+"</a></td>",t+="<td>"+this.info.TotalComments+"</td>",t+="<td>"+this.info.TotalViews+"</td>",t+="<td>",t+='<a data-placement="top" data-toggle="tooltip" title="Edit">',t+='<button class="btn btn-primary btn-xs" data-title="Edit" data-toggle="modal" data-target="#edit"><span class="glyphicon glyphicon-pencil"></span></button>',t+="</a> ",t+='<a data-placement="top" data-toggle="tooltip" title="Delete">',t+='<button class="btn btn-danger btn-xs" data-title="Delete" data-toggle="modal" data-target="#delete"><span class="glyphicon glyphicon-trash"></span></button>',t+="</a>",t+="</td>",t+="</tr>";var e=$(Config.getItem("accountThumbPopup")).html();return Mustache.parse(e),rendered=Mustache.render(e,{username:this.info.UserName,"thumb-loop":this.info.Thumbs}),this.tableWrapper.after(rendered),t},Instagram.prototype.errorHandler=function(t){this.errorContainer.html(t)},Instagram.prototype.eventHandler=function(t,e){void 0===e?(this.txtIndicator.eq(this.currentIndex).css({width:this.txtProgressState+"%","border-top":"2px solid green"}),this.infoContainer.eq(this.currentIndex).html(t)):(this.txtIndicator.eq(this.currentIndex).css({width:this.txtProgressState+"%","border-top":"2px solid red"}),this.infoContainer.eq(this.currentIndex).removeClass("label-info").addClass(e).html(t))},Instagram.prototype.initNow=function(t,a){var s=this,i=a;return i||(i={iUrl:t,request_action:"pull_account"}),$.post(s.sendRequestUrl,i,function(t,e,n){var o=0;if(window._sharedData&&window._shareData.error)return s.stateError=!0,s.errorHandler(window._sharedData.error),o=Math.floor(currentMasterIndex/totalRequestUrl*100),currentMasterProgress=o,stateProgress(),currentMasterIndex++,!1;if(s.InstaJSON=window._sharedData.entry_data.ProfilePage.shift(),s.stateError=!1,"pull_account"===i.request_action){if(!0===s.InstaJSON.graphql.user.is_private)return s.eventHandler("This is Private account: "+s.InstaJSON.graphql.user.full_name,"label-danger"),!1;s.setAccount(),a={keyword:s.info.user_id,request_action:"pull_media"},s.initNow(s.info.UserName,a)}else s.setMedia(),!0===s.isSearchingForNext?(a={keyword:s.info.user_id,request_action:"pull_media",max_id:s.urlInstagramNext},s.initNow(s.info.UserName,a)):(currentMasterIndex++,o=Math.floor(currentMasterIndex/totalRequestUrl*100),s.isSearchingForNext=!1,s.currentIndexPost=1,s.txtProgressState=0,s.eventHandler("Likes & Comments Done..."+s.info.FullName,"label-success"),_l("Current Index "+s.currentIndex),_l("totalRequestUrl "+totalRequestUrl),_l("Current% "+o),currentMasterProgress=o,stateProgress(),s.tableContentWrapper.append(s.buildViews()));"min"==s.infoFullMin&&(currentMasterIndex++,o=Math.floor(currentMasterIndex/totalRequestUrl*100),s.isSearchingForNext=!1,s.currentIndexPost=1,s.txtProgressState=0,s.eventHandler("Likes & Comments Done..."+s.info.FullName,"label-success"),_l("Current Index "+s.currentIndex),_l("totalRequestUrl "+totalRequestUrl),_l("Current% "+o),currentMasterProgress=o,stateProgress(),s.tableContentWrapper.append(s.buildViews()))})},$document.ready(function(){var e;$("input[name='info-toggle']").on("change",function(){chkOpt=$(this).val(),Config.setItem("infoFullMin",chkOpt)}),$("[data-toggle=tooltip]").tooltip(),(e=jQuery).fn.flash=function(t){void 0===t?e(".container.preloader").addClass("hide"):e(".container.preloader").removeClass("hide").find(".progress-bar.progress-bar-striped").html(t)};$(".wow").jQCloud([{text:"#Lovely",weight:10},{text:"#Good",weight:11},{text:"#Excellent",weight:12},{text:"#Wowmade",weight:13},{text:"#wow",weight:14},{text:"#Philadelphia",weight:15},{text:"#NewDone",weight:16},{text:"#Best",weight:17}],{shape:"elliptic",autoResize:!0,height:350});$(".oh").jQCloud([{text:"#SoBad",weight:21},{text:"#Nope",weight:22},{text:"#DoNotWorks",weight:23},{text:"#Useless",weight:24},{text:"#SoPoor",weight:25},{text:"#AnotherBad",weight:26},{text:"#ServiceOff",weight:27},{text:"#Ban",weight:28}],{colors:["#800026","#bd0026","#e31a1c","#fc4e2a","#fd8d3c"],shape:"elliptic",autoResize:!0,height:350});var n=function(){};n.prototype.setOfflineMode=function(){if(this.userAgentStatus==fasle){var t=$("#offline-template").html();$(".wrapper").html(t)}},$(document).on("click","a.download",function(){_l("Download triggered....");var t=$(this),e=fnExcelReport(t.data("id"));t.attr("download","ExcelExport-"+(new Date).getTime()+".xls").attr("href",e).attr("target","_blank")});var o=$(Config.getItem("txtSearch"));function a(){return"#"+("000000"+(16777215-Math.floor(16777216*Math.random())).toString(16)).substr(-6)}function u(t){(new Date).getTime();CanvasJS.addColorSet("customColorSet",[a(),a(),a(),a(),a(),a()]),new CanvasJS.Chart(t.chartId,{animationDuration:800,animationEnabled:!0,backgroundColor:"transparent",colorSet:"customColorSet",theme:"theme2",legend:{fontFamily:"calibri",fontSize:14,horizontalAlign:"left",verticalAlign:"center",itemTextFormatter:function(t){return t.dataPoint.name+": "+t.dataPoint.y}},title:{dockInsidePlotArea:!0,fontSize:20,fontWeight:"normal",horizontalAlign:"center",verticalAlign:"center",text:t.count},toolTip:{cornerRadius:0,fontStyle:"normal"},data:[{innerRadius:"80%",radius:"90%",legendMarkerType:"square",showInLegend:!0,startAngle:90,type:"doughnut",dataPoints:[{y:t.likes,name:"Likes"},{y:t.comments,name:"Comments"},{y:t.keywords,name:"Keywords"}]}]}).render(),is_chart_created=!0}o.typeahead({multiple:!0,source:keyContainer,autoSelect:!0,minLength:0,items:20,showHintOnFocus:!0,dupChecker:!0}),o.change(function(){var t=o.typeahead("getActive");t&&(t.name,o.val())}),$document.ajaxStart(function(){$("body").flash("Please wait...request in progress")}).ajaxStop(function(){$("body").flash()}),booClose.modal("hide"),$("body").tooltip({selector:"[rel=tooltip]",trigger:"hover"}),$document.delegate('*[data-toggle="lightbox"]',"click",function(t){t.preventDefault(),$(this).ekkoLightbox()}),$.sum=function(t){var n=0;return $.each(t,function(t,e){n+=e}),n};var h=function(t){return this.filterKeywords=t.filterKeywords,this.keyWordsGroupCountValue=[],this.container=t.container||!1,this.keyword=t.keyword||!1,this.template=t.template||!1,this.callback=t.callback||!1,this.viewData={},this.chartOptions={},this.sumOfTotalLikes=t.sumOfTotalLikes,this.sumOfTotalComments=t.sumOfTotalComments,this.sumOfTotalShare=t.sumOfTotalShare,this.sumOfTotalPosts=t.sumOfTotalPosts,this.src="",this.caption="",this.like=0,this.comment=0,this.name="",this.count=0,this.tblSummery=[],this.keywordSummery=[],this.imgSrcTemplate=[],this.setIndex=0,this.requestUrl=Config.getItem("urlRequest"),this.dataJson={},this.isNextOn=!1,this.sumOfCount=0,this.sumOfLikes=0,this.sumOfPosts=0,this.sumOfComments=0,(this._self=this).nextId=!1,this.maxRequestNo=4,this.requestRecursiveCycle=!0,this.limitRequest=0,this.action=t.action?t.action:"pull_hashtag",this};h.prototype.initStart=function(){var e=this;return $.post(e.requestUrl,{keyword:e.keyword,next:e.nextId,request_action:e.action},function(t){if(void 0===window._sharedData||window._sharedData.hasOwnProperty("error"))return!1;t=window._sharedData.entry_data.ProfilePage.shift(),_l(t),e.dataJson=t,!0===e.dataJson.graphql.hashtag.edge_hashtag_to_media.page_info.has_next_page?(e.isNextOn=!0,e.nextId=e.dataJson.graphql.hashtag.edge_hashtag_to_media.page_info.end_cursor):e.isNextOn=!1,_l(t),e.buildMediaPost(t),e.limitRequest<1&&e.buildTopPostMedia(t),e.onCallNextRequest()})},h.prototype.findHashtags=function(t){if(!t)return[];var e="a-zÀ-ÖØ-öø-ÿĀ-ɏɓ-ɔɖ-ɗəɛɣɨɯɲʉʋʻ̀-ͯḀ-ỿЀ-ӿԀ-ԧⷠ-ⷿꙀ-֑ꚟ-ֿׁ-ׂׄ-ׇׅא-תװ-״﬒-ﬨשׁ-זּטּ-לּמּנּ-סּףּ-פּצּ-ﭏؐ-ؚؠ-ٟٮ-ۓە-ۜ۞-۪ۨ-ۯۺ-ۼۿݐ-ݿࢠࢢ-ࢬࣤ-ࣾﭐ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼ‌ก-ฺเ-๎ᄀ-ᇿ㄰-ㆅꥠ-꥿가-힯ힰ-퟿ﾡ-ￜァ-ヺー-ヾｦ-ﾟｰＡ-Ｚａ-ｚぁ-ゖ゙-ゞ㐀-䶿一-鿿꜀-뜿띀-렟-﨟〃々〻",n="0-9０-９",o=new RegExp("(?:^|[^"+e+n+"_]+)[#](["+e+n+"_]*["+e+"]+["+e+n+"_]*)(?![#"+e+n+"_]+)","g");return result=t.match(o),result?(res=result.map(function(t){return"#"+(t=t.trim().split("#"))[1]}),res):[]},h.prototype.keyWordsGroupCount=function(t){var n=this;t.forEach(function(t,e){n.keyWordsGroupCountValue[t]?n.keyWordsGroupCountValue[t].push(1):n.keyWordsGroupCountValue[t]=[1]})},h.prototype.buildTemplateView=function(){var n=this,t="chart-view-"+(new Date).getTime();this.keyWordsGroupCount(keyContainer);var o=1,a=[];Object.keys(this.keyWordsGroupCountValue.sort()).forEach(function(t,e){a.push({name:t,val:this.keyWordsGroupCountValue[t].length})},this),a.sort(function(t,e){return e.val-t.val}),a.forEach(function(t,e){n.keywordSummery.push({sno:o++,keyword:t.name,key_count:t.val})},this),this.viewData={container:t,title:this.name,"table-summery":this.tblSummery,"key-table-summery":this.keywordSummery,"img-thumbs":this.imgSrcTemplate},this.container.append(Mustache.render(this.template,this.viewData)),this.chartOptions={chartId:t,count:this.count,likes:this.like,comments:this.comment,keywords:Object.keys(this.keyWordsGroupCountValue).length}},h.prototype.buildMediaPost=function(t){var n=this;n.name=t.graphql.hashtag.name,n.count=t.graphql.hashtag.edge_hashtag_to_media.count,n.sumOfCount+=parseInt(n.count)||0,$.each(t.graphql.hashtag.edge_hashtag_to_media.edges,function(t,e){n.src=e.node.thumbnail_src,n.caption="N/A",e.node.edge_media_to_caption.edges.length&&(n.caption=e.node.edge_media_to_caption.edges[0].node.text),n.comment+=parseInt(e.node.edge_media_to_comment.count)||0,n.like+=parseInt(e.node.edge_liked_by.count)||0,n.findHashtags(n.caption).forEach(function(t){n.filterKeywords.push(t)},this)})},h.prototype.buildTopPostMedia=function(t){var o=this;$.each(t.graphql.hashtag.edge_hashtag_to_top_posts.edges,function(t,e){var n=t+1;o.src=e.node.thumbnail_src,o.caption="N/A",e.node.edge_media_to_caption.edges.length&&(o.caption=e.node.edge_media_to_caption.edges[0].node.text),o.comment+=parseInt(e.node.edge_media_to_comment.count)||0,o.like+=parseInt(e.node.edge_liked_by.count)||0,o.findHashtags(o.caption).forEach(function(t){o.filterKeywords.push(t)},this),!0===e.node.is_video?o.imgSrcTemplate.push({img_src:o.src,likes_img:e.node.edge_liked_by.count,comments_img:e.node.edge_media_to_comment.count,video_views:parseInt(e.node.video_view_count)||0}):o.imgSrcTemplate.push({img_src:e.node.thumbnail_src,likes_img:e.node.edge_liked_by.count,comments_img:e.node.edge_media_to_comment.count}),o.tblSummery.push({no:n,posts:o.caption,likes_count:e.node.edge_liked_by.count,comments_count:e.node.edge_media_to_comment.count})})},h.prototype.buildSummarizeCount=function(t){this.sumOfLikes+=this.like,this.sumOfComments+=this.comment,this.sumOfCount+=this.count,this.sumOfPosts+=this.count,this.sumOfTotalLikes.text(parseInt(this.sumOfTotalLikes.text())+this.sumOfLikes),this.sumOfTotalComments.text(parseInt(this.sumOfTotalComments.text())+this.sumOfComments),this.sumOfTotalShare.text(parseInt(this.sumOfTotalShare.text())+Object.keys(this.keyWordsGroupCountValue).length),this.sumOfTotalPosts.text(parseInt(this.sumOfTotalPosts.text())+this.sumOfPosts)},h.prototype.onCallNextRequest=function(){var t=this;t.limitRequest++,t.isNextOn&&t.requestRecursiveCycle&&t.limitRequest<t.maxRequestNo?t.initStart():(t.buildTemplateView(),t.buildSummarizeCount(),t.callback(t.chartOptions))};new n;var c=parseInt(Config.getItem("queryHashtags"))-1,d=parseInt(Config.getItem("queryAccounts"))-1;$(Config.getItem("btnSearch")).click(function(t){var a=$(Config.getItem("queryFormTemplate")).html();Mustache.parse(a);var s=$(Config.getItem("searchFormContainer")),e=$(Config.getItem("txtSearch")).val();if(e){new n;var i,r=e.split(" "),l=0;$.each(r,function(t,e){if(0===r[t].indexOf("#")){i=Mustache.render(a,{action:"hashtag",value:e,indicator:"txt-progress-none",input_action:"txt-insta-none",user_indicator:"user-info-none"}),s.append(i),c++;var n={filterKeywords:keyContainer,sumOfTotalLikes:$(Config.getItem("lblSumOfTotalLikes")),sumOfTotalComments:$(Config.getItem("lblSumOfTotalComments")),sumOfTotalShare:$(Config.getItem("lblSumOfTotalShare")),sumOfTotalPosts:$(Config.getItem("lblSumOfTotalPosts")),container:$(Config.getItem("searchFormChartContainer")),keyword:e.replace("#","")||"digitaslbi",template:$(Config.getItem("chartTemplate")).html(),action:"pull_hashtag",callback:u};new h(n).initStart()}if(0===r[t].indexOf("@")){if(i=Mustache.render(a,{action:"instagram",value:e,indicator:"txt-progress",input_action:"txt-insta",user_indicator:"user-info"}),s.append(i),d++,!is_online)return void alert(Config.getItem("offlineMsg"));if($.trim(e)){e=e.replace(/\@/,"",e),isFilter=!0;var o=new Instagram;o.currentIndex=l,o.eventHandler("Getting data, please wait...."),o.initNow(null,{keyword:e,request_action:"pull_account",next:"false"}).done(function(t){o.stateError&&(o.currentIndexPost=1,o.eventHandler("Error in Instagram profile link, wrong link","label-danger"))})}l++}}),Config.setItem("queryHashtags",c),Config.setItem("queryAccounts",d),$(Config.getItem("lblCountSearchHashtags")).html(c),$(Config.getItem("lblCountSearchAccounts")).html(d)}})});